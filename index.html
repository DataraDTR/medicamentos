<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calendario de Medicación - Checklist</title>
  <link rel="icon" type="image/png" href="src/favicon-32x32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="src/favicon-16x16.png" sizes="16x16" />
  <link rel="apple-touch-icon" href="src/apple-touch-icon.png" />
  <link rel="android-chrome-192x192" href="src/android-chrome-192x192.png" />
  <link rel="android-chrome-512x512" href="src/android-chrome-512x512.png" />
  <link rel="manifest" href="src/site.webmanifest" />
  <style>
    :root{
      --bg:#f9fafb;
      --card:#ffffff;
      --accent:#2563eb;
      --muted:#6b7280;
      --ok:#10b981;
      --warn:#f59e0b;
      --error:#ef4444;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:#111827}
    .wrap{max-width:900px;margin:20px auto;padding:16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-size:18px;color:#1e3a8a}
    p.lead{margin:4px 0 0;color:var(--muted);font-size:14px}
    .controls{display:flex;gap:6px;flex-wrap:wrap;margin-top:12px}
    button{background:var(--accent);color:white;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;transition:background .2s;font-size:14px}
    button:hover{background:#1d4ed8}
    .grid{display:grid;grid-template-columns:1fr 260px;gap:16px;margin-top:16px}
    .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.08)}
    .schedule{max-height:60vh;overflow:auto;padding-right:4px;font-size:14px}
    .slot{display:flex;gap:10px;align-items:flex-start;padding:8px;border-radius:8px;margin-bottom:6px;border:1px solid #e5e7eb;background:#f9fafb}
    .time{width:70px;font-weight:600;color:#1d4ed8;font-size:13px}
    .items{flex:1}
    .item{display:flex;gap:6px;align-items:center;margin-bottom:4px}
    .medname{font-size:13px}
    label.check{display:flex;gap:6px;align-items:center;cursor:pointer}
    input[type=checkbox]{width:16px;height:16px;border-radius:4px}
    footer.small{color:var(--muted);font-size:12px;margin-top:10px}
    .rightpanel{position:sticky;top:16px}
    .meta{display:flex;flex-direction:column;gap:6px;font-size:13px}
    .stats{display:flex;gap:6px;flex-wrap:wrap}
    .stat{background:#f3f4f6;padding:6px;border-radius:8px;min-width:80px;text-align:center;font-size:13px}
    .stat > div:first-child{font-weight:600}
    .filters{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .filters label{font-size:13px;display:flex;gap:4px;align-items:center}
    .dayheader{font-weight:700;margin-top:10px;margin-bottom:4px;color:var(--accent);font-size:14px}
    .smallmuted{color:var(--muted);font-size:12px}
    .pendingList{margin-top:8px;background:#fff7ed;padding:8px;border-radius:8px;border:1px solid #fed7aa;font-size:13px}
    .pendingItem{font-size:12px;color:var(--warn);margin-bottom:4px}
    .error-message{background:#fee2e2;padding:8px;border-radius:8px;border:1px solid var(--error);color:var(--error);font-size:13px;margin-bottom:8px;display:none}
    .tempEntry{background:#f9fafb;padding:6px;border-radius:6px;margin-bottom:4px;font-size:12px;border:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
    .tempEntry .tempValue{font-weight:600;color:#1d4ed8}
    .tempEntry .deleteBtn{background:#ef4444;color:white;border:none;padding:1px 6px;border-radius:4px;cursor:pointer;font-size:10px}
    .tempEntry .deleteBtn:hover{background:#dc2626}
    #addTemp{padding:6px 10px;font-size:13px}
    #tempInput{padding:5px;border:1px solid #d1d5db;border-radius:6px;font-size:13px}
    .meta > div[style*="margin-top:8px"] .smallmuted{font-weight:600}
    @media (max-width: 550px) {
      .wrap{margin:12px auto;padding:12px}
      header{gap:8px;flex-direction:column;align-items:stretch}
      h1{font-size:17px}
      p.lead{font-size:13px}
      .controls{justify-content:flex-start;margin-top:8px}
      button{padding:5px 8px;font-size:13px}
      .grid{grid-template-columns:1fr 240px;gap:12px}
      .schedule{max-height:55vh;padding-right:2px;font-size:13px}
      .slot{gap:8px;padding:6px;margin-bottom:4px}
      .time{width:60px;font-size:12px}
      .medname{font-size:12px}
      input[type=checkbox]{width:15px;height:15px}
      .item{gap:5px;margin-bottom:3px}
      .dayheader{margin-top:8px;margin-bottom:3px;font-size:13px}
      .rightpanel{top:12px}
      .meta{gap:5px}
      .stats{gap:5px}
      .stat{min-width:70px;padding:5px;font-size:12px}
      .filters{gap:5px}
      .filters label{font-size:12px}
      .pendingList{padding:6px;margin-top:6px;font-size:12px}
      .pendingItem{font-size:11px;margin-bottom:3px}
      .error-message{padding:6px;font-size:12px;margin-bottom:6px}
      .tempEntry{padding:5px;margin-bottom:3px;font-size:11px}
      .tempEntry .deleteBtn{padding:1px 5px;font-size:9px}
      #tempList{max-height:150px}
      .card{padding:10px}
      footer.small{font-size:11px;margin-top:8px}
    }
    @media (max-width: 400px) {
      .grid{grid-template-columns:1fr}
      .rightpanel{position:static}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Calendario de medicación — Checklist</h1>
        <p class="lead">Inicia: <strong>23-10-2025 a las 12:00</strong>. Marca las tomas cuando las completes. Los cambios se guardan en Firebase.</p>
      </div>
      <div class="controls">
        <button id="toggleGroup">Agrupar por hora</button>
      </div>
    </header>
    <div class="grid">
      <section class="card">
        <div class="error-message" id="errorMessage"></div>
        <div class="schedule" id="schedule"></div>
        <footer class="small">Marca tus medicaciones al tomarlas. Se guardan automáticamente en Firebase.</footer>
      </section>
      <aside class="rightpanel">
        <div class="card meta">
          <div class="smallmuted">Resumen</div>
          <div class="stats">
            <div class="stat">
              <div id="totalEvents">0</div>
              <div class="smallmuted">Tomas programadas</div>
            </div>
            <div class="stat">
              <div id="doneCount">0</div>
              <div class="smallmuted">Completadas</div>
            </div>
            <div class="stat">
              <div id="pendingCount">0</div>
              <div class="smallmuted">Pendientes</div>
            </div>
          </div>
          <div id="pendingBox" class="pendingList" style="display:none">
            <div class="smallmuted"><strong>Pendientes recientes:</strong></div>
            <div id="pendingItems"></div>
          </div>
          <div style="margin-top:8px" class="smallmuted">Filtros</div>
          <div class="filters">
            <label><input type="checkbox" data-filter="gotas" checked /> Gotas</label>
            <label><input type="checkbox" data-filter="loperamida" checked /> Loperamida</label>
            <label><input type="checkbox" data-filter="viadil" checked /> Viadil</label>
            <label><input type="checkbox" data-filter="paracetamol" checked /> Paracetamol</label>
            <label><input type="checkbox" data-filter="ipratropio" checked /> Ipratropio</label>
            <label><input type="checkbox" data-filter="azitromicina" checked /> Azitromicina</label>
          </div>
        </div>
        <div class="card meta" style="margin-top:14px">
          <div class="smallmuted"><strong>Registro de Temperatura</strong></div>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end">
            <div style="flex:1;min-width:120px">
              <label style="font-size:12px;color:var(--muted)">Temperatura (°C)</label>
              <input type="number" id="tempInput" step="0.1" placeholder="36.5" style="width:100%;padding:6px;border:1px solid #d1d5db;border-radius:6px;margin-top:4px" />
            </div>
            <button id="addTemp" style="padding:6px 12px;font-size:14px">Agregar</button>
          </div>
          <div id="tempList" style="margin-top:12px;max-height:200px;overflow-y:auto"></div>
        </div>
      </aside>
    </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    if (typeof firebase === 'undefined') {
      document.getElementById('errorMessage').innerHTML = 'Error: Firebase no disponible. Verifica tu conexión.';
      document.getElementById('errorMessage').style.display = 'block';
    }
    const firebaseConfig = {
      apiKey: "AIzaSyC5nlgiGkmViycXzgo3wqbtYnU6-k4sMHc",
      authDomain: "medicamentos-a6cc5.firebaseapp.com",
      projectId: "medicamentos-a6cc5",
      storageBucket: "medicamentos-a6cc5.firebasestorage.app",
      messagingSenderId: "277925766458",
      appId: "1:277925766458:web:ac77a9b51e0541a5c39c03",
      measurementId: "G-7TNMZ1V64C"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const userId = 'default_user';
    const START = new Date(2025, 9, 23, 12, 0, 0);
    const meds = [
      { id: 'gotas', name: 'Gotas', freq: 4, days: 7 },
      { id: 'loperamida', name: 'Loperamida 1 c/u', freq: 6, days: 4, offset: 4 },
      { id: 'ipratropio', name: 'Ipratropio 2 puff', freq: 6, days: 4 },
      { id: 'viadil', name: 'Viadil compuesto 35 gotas', freq: 8, days: 3 },
      { id: 'paracetamol', name: 'Paracetamol 1 g', freq: 8, days: 4 },
      { id: 'azitromicina', name: 'Azitromicina 1/día', freq: 24, days: 6, offset: 4 }
    ];
    let checked = {};
    let events = [];
    let temperatures = [];
    function showError(message) {
      const errorEl = document.getElementById('errorMessage');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    }
    function clearError() {
      const errorEl = document.getElementById('errorMessage');
      errorEl.textContent = '';
      errorEl.style.display = 'none';
    }
    async function loadCheckedData() {
      try {
        const doc = await db.collection('medication_checks').doc(userId).get();
        if (doc.exists) {
          const data = doc.data();
          checked = data.checks || {};
          temperatures = data.temperatures || [];
        } else {
          checked = {};
          temperatures = [];
        }
        clearError();
      } catch (error) {
        showError('Error al cargar los datos. Por favor, intenta de nuevo.');
        throw error;
      }
    }
    async function persist() {
      try {
        await db.collection('medication_checks').doc(userId).set({
          checks: checked,
          temperatures: temperatures,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
        clearError();
      } catch (error) {
        showError('Error al guardar los datos. Por favor, intenta de nuevo.');
      }
    }
    function addHours(d, h) {
      return new Date(d.getTime() + h * 60 * 60 * 1000);
    }
    function formatDateTime(dt) {
      const p = n => n.toString().padStart(2, '0');
      return `${p(dt.getDate())}-${p(dt.getMonth() + 1)}-${dt.getFullYear()} ${p(dt.getHours())}:${p(dt.getMinutes())}`;
    }
    function formatTime(dt) {
      const p = n => n.toString().padStart(2, '0');
      return `${p(dt.getHours())}:${p(dt.getMinutes())}`;
    }
    function generateSchedule() {
      events = [];
      const now = new Date();
      const today = new Date(2025, 9, 23);
      const isToday = now.toDateString() === today.toDateString();
      meds.forEach(m => {
        let startOffset = (m.offset || 0) * 60 * 60 * 1000;
        let initialStart = new Date(START.getTime() + startOffset);
        let cur = new Date(initialStart.getTime());
        const end = new Date(START.getTime() + m.days * 24 * 60 * 60 * 1000);
        if (isToday && checked[`skipped_${m.id}`]) {
          const skippedTime = new Date(checked[`skipped_${m.id}`]);
          cur = new Date(skippedTime.getTime());
          cur = addHours(cur, m.freq);
        }
        while (cur <= end) {
          events.push({ id: `${m.id}_${cur.getTime()}`, medId: m.id, medName: m.name, time: new Date(cur) });
          cur = addHours(cur, m.freq);
        }
      });
      events.sort((a, b) => a.time - b.time);
    }
    function render() {
      const scheduleEl = document.getElementById('schedule');
      scheduleEl.innerHTML = '';
      if (events.length === 0) {
        scheduleEl.innerHTML = '<div>No hay tomas programadas.</div>';
        return;
      }
      const now = new Date();
      const byDay = {};
      events.forEach(e => {
        const k = e.time.toISOString().slice(0, 10);
        if (!byDay[k]) byDay[k] = [];
        byDay[k].push(e);
      });
      let total = 0, done = 0;
      const pendingNow = [];
      Object.keys(byDay).sort().forEach(day => {
        const header = document.createElement('div');
        header.className = 'dayheader';
        const p = day.split('-');
        header.textContent = `${p[2]}-${p[1]}-${p[0]}`;
        scheduleEl.appendChild(header);
        const byTime = {};
        byDay[day].forEach(e => {
          const t = formatTime(e.time);
          if (!byTime[t]) byTime[t] = [];
          byTime[t].push(e);
        });
        Object.keys(byTime).sort().forEach(t => {
          const slot = document.createElement('div');
          slot.className = 'slot';
          const timeEl = document.createElement('div');
          timeEl.className = 'time';
          timeEl.textContent = t;
          const itemsEl = document.createElement('div');
          itemsEl.className = 'items';
          byTime[t].forEach(ev => {
            total++;
            const chk = !!checked[ev.id];
            if (chk) done++;
            if (!chk && ev.time < now) {
              pendingNow.push(`${formatDateTime(ev.time)} → ${ev.medName}`);
            }
            const div = document.createElement('div');
            div.className = 'item';
            const label = document.createElement('label');
            label.className = 'check';
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.checked = chk;
            cb.addEventListener('change', async () => {
              checked[ev.id] = cb.checked;
              await persist();
              render();
            });
            const name = document.createElement('div');
            name.className = 'medname';
            name.textContent = ev.medName;
            label.appendChild(cb);
            label.appendChild(name);
            div.appendChild(label);
            itemsEl.appendChild(div);
          });
          slot.appendChild(timeEl);
          slot.appendChild(itemsEl);
          scheduleEl.appendChild(slot);
        });
      });
      document.getElementById('totalEvents').textContent = total;
      document.getElementById('doneCount').textContent = done;
      document.getElementById('pendingCount').textContent = total - done;
      const pb = document.getElementById('pendingBox');
      const pi = document.getElementById('pendingItems');
      if (pendingNow.length > 0) {
        pb.style.display = 'block';
        pi.innerHTML = pendingNow.map(p => `<div class='pendingItem'>${p}</div>`).join('');
      } else {
        pb.style.display = 'none';
      }
    }
    function renderTemperatures() {
      const tempList = document.getElementById('tempList');
      if (temperatures.length === 0) {
        tempList.innerHTML = '<div class="smallmuted" style="padding:8px">No hay registros aún</div>';
        return;
      }
      const sorted = [...temperatures].sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
      tempList.innerHTML = sorted.map((t, idx) => {
        const dt = new Date(t.datetime);
        const realIdx = temperatures.findIndex(temp => temp.datetime === t.datetime && temp.value === t.value);
        return `
          <div class="tempEntry">
            <div>
              <div>${formatDateTime(dt)}</div>
              <div class="tempValue">${t.value}°C</div>
            </div>
            <button class="deleteBtn" onclick="deleteTemp(${realIdx})">Eliminar</button>
          </div>
        `;
      }).join('');
    }
    window.deleteTemp = async function(index) {
      temperatures.splice(index, 1);
      await persist();
      renderTemperatures();
    }
    async function addTemperature() {
      const input = document.getElementById('tempInput');
      const value = parseFloat(input.value);
      if (isNaN(value) || value < 30 || value > 45) {
        alert('Por favor ingresa una temperatura válida (30-45°C)');
        return;
      }
      const now = new Date();
      temperatures.push({
        datetime: now.toISOString(),
        value: value
      });
      input.value = '';
      await persist();
      renderTemperatures();
    }
    function checkAndReschedule() {
      const now = new Date();
      const today = new Date(2025, 9, 23);
      const isToday = now.toDateString() === today.toDateString();
      if (!isToday) return;
      let needsUpdate = false;
      events.forEach(ev => {
        const timeDiff = now - ev.time;
        const oneHour = 60 * 60 * 1000;
        if (ev.medId === 'gotas') return;
        if (timeDiff > oneHour && !checked[ev.id] && !checked[`skipped_${ev.medId}`]) {
          checked[`skipped_${ev.medId}`] = ev.time.toISOString();
          needsUpdate = true;
        }
      });
      if (needsUpdate) {
        persist();
        generateSchedule();
        render();
      }
    }
    async function init() {
      try {
        await loadCheckedData();
        generateSchedule();
        render();
        renderTemperatures();
        setInterval(checkAndReschedule, 60000);
        document.getElementById('addTemp').addEventListener('click', addTemperature);
        document.getElementById('tempInput').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') addTemperature();
        });
      } catch (error) {
        console.error('Initialization failed:', error);
      }
    }
    init();
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('Service Worker registrado:', registration);
          })
          .catch(error => {
            console.error('Error al registrar Service Worker:', error);
          });
      });
    }
  </script>
</body>
</html>